<div class="tasks-container" dir="rtl">
  <div class="header-section">
    <div class="title-area">
      <a [routerLink]="['/projects', teamId()]" class="back-link">â†’ ×—×–×¨×” ×œ×¤×¨×•×™×§×˜×™×</a> 
      <h2>{{ getProjectName() }}</h2>
    </div>
    <button class="add-task-btn" (click)="showForm.set(!showForm())">
      <span>+ ××©×™××” ×—×“×©×”</span>
    </button>
  </div>

  @if (showForm()) {
    <div class="add-task-modal" (click)="showForm.set(false)">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h3>××©×™××” ×—×“×©×”</h3>
        <input [(ngModel)]="newTask.title" placeholder="×›×•×ª×¨×ª ×”××©×™××”" autofocus>
        <textarea [(ngModel)]="newTask.description" placeholder="×ª×™××•×¨" rows="3"></textarea>
        <div class="row">
          <select [(ngModel)]="newTask.priority">
            <option value="low">× ××•×›×”</option>
            <option value="normal">×¨×’×™×œ×”</option>
            <option value="high">×’×‘×•×”×”</option>
          </select>
          <input type="date" [(ngModel)]="newTask.dueDate">
        </div>
        <div class="modal-footer">
          <button class="btn-cancel" (click)="showForm.set(false)">×‘×™×˜×•×œ</button>
          <button class="btn-save" (click)="addTask()">×©××•×¨</button>
        </div>
      </div>
    </div>
  }

  @if (isLoading()) { <div class="loading">×˜×•×¢×Ÿ...</div> }

  <div class="kanban-board">
    <div class="kanban-column">
      <div class="column-header backlog"><h3>×œ×‘×™×¦×•×¢</h3></div>
      <div class="column-content">
        @for (task of getTasksByStatus('todo'); track task.id) {
          <div class="task-card">
            <div class="task-header">
              <h4>{{ task.title }}</h4>
              <button class="delete-btn" (click)="removeTask(task.id!)">Ã—</button>
            </div>
            <p>{{ task.description }}</p>
            <div class="actions">
              <button (click)="changeStatus(task.id!, 'in_progress')">×”×ª×—×œ â†</button>
              <button class="comment-btn" (click)="toggleComments(task.id!)">ğŸ’¬</button>
            </div>
            @if (activeTaskId() === task.id) {
               <ng-container *ngTemplateOutlet="commentsTemplate; context: {$implicit: task}"></ng-container>
            }
          </div>
        }
      </div>
    </div>

    <div class="kanban-column">
      <div class="column-header in-progress"><h3>×‘×ª×”×œ×™×š</h3></div>
      <div class="column-content">
        @for (task of getTasksByStatus('in_progress'); track task.id) {
          <div class="task-card">
            <div class="task-header">
              <h4>{{ task.title }}</h4>
              <button class="delete-btn" (click)="removeTask(task.id!)">Ã—</button>
            </div>
            <p>{{ task.description }}</p>
            <div class="actions">
              <button (click)="changeStatus(task.id!, 'done')">×¡×™×™× â†’</button>
              <button class="comment-btn" (click)="toggleComments(task.id!)">ğŸ’¬</button>
            </div>
            @if (activeTaskId() === task.id) {
               <ng-container *ngTemplateOutlet="commentsTemplate; context: {$implicit: task}"></ng-container>
            }
          </div>
        }
      </div>
    </div>

    <div class="kanban-column">
      <div class="column-header done"><h3>×‘×•×¦×¢</h3></div>
      <div class="column-content">
        @for (task of getTasksByStatus('done'); track task.id) {
          <div class="task-card completed">
            <div class="task-header">
              <h4>{{ task.title }}</h4>
              <button class="delete-btn" (click)="removeTask(task.id!)">Ã—</button>
            </div>
            <div class="actions">
              <button (click)="changeStatus(task.id!, 'in_progress')">â† ×”×—×–×¨</button>
              <button class="comment-btn" (click)="toggleComments(task.id!)">ğŸ’¬</button>
            </div>
            @if (activeTaskId() === task.id) {
               <ng-container *ngTemplateOutlet="commentsTemplate; context: {$implicit: task}"></ng-container>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>

<ng-template #commentsTemplate let-task>
  <div class="comments-section">
    <div class="comments-list">
      @for (c of currentComments(); track c.id) {
        <div class="comment"><strong>{{ c.author_name || '××©×ª××©' }}:</strong> {{ c.body }}</div>
      }
    </div>
    <div class="add-comment">
      <input #txt placeholder="×ª×’×•×‘×”..." (keyup.enter)="addComment(task.id!, txt.value); txt.value=''">
      <button (click)="addComment(task.id!, txt.value); txt.value=''">×©×œ×—</button>
    </div>
  </div>
</ng-template>